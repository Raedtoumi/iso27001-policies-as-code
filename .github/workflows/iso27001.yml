name: ISO27001 Security Compliance Checks

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  iso27001-compliance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Open Policy Agent
      run: |
        curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
        chmod +x opa
        sudo mv opa /usr/local/bin/

    - name: Validate policy syntax
      run: |
        echo "Checking policy syntax..."
        opa check policies/
        echo "✅ All policies have valid syntax"

    - name: Run ISO 27001 compliance checks
      run: |
        mkdir -p results
        echo "Running OPA evaluation..."
        opa eval --format json --data policies/ --input deployment.json "data.security.allow" > results/opa_results.json
        
        echo "Compliance results:"
        cat results/opa_results.json
        
        # Check if deployment is allowed (no violations)
        if jq -e '.result[0].expressions[0].value == true' results/opa_results.json; then
          echo "✅ All ISO 27001 policies passed!"
        else
          echo "❌ Compliance violations detected!"
          # Get the deny messages
          opa eval --format json --data policies/ --input deployment.json "data.security.deny" > results/violations.json
          echo "=== VIOLATIONS ==="
          jq '.result[0].expressions[0].value' results/violations.json
          exit 1
        fi

    - name: Upload compliance report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: iso27001-compliance-report
        path: results/